{% extends "base.html" %}
{% block content %}
<nav class="bg-gray-800 text-white p-4 mb-6 rounded-lg">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <a href="{{ url_for('index', page='dashboard') }}" class="hover:bg-gray-700 px-3 py-2 rounded {{ 'bg-gray-700' if page == 'dashboard' else '' }}">Dashboard</a>
            {% if session['role'] in ['Administrator', 'Approver'] %}
                <a href="{{ url_for('index', page='pending') }}" class="hover:bg-gray-700 px-3 py-2 rounded {{ 'bg-gray-700' if page == 'pending' else '' }}">Pending</a>
            {% endif %}
            {% if session['role'] == 'Administrator' %}
                <a href="{{ url_for('index', page='devices') }}" class="hover:bg-gray-700 px-3 py-2 rounded {{ 'bg-gray-700' if page == 'devices' else '' }}">Devices</a>
                <a href="{{ url_for('settings') }}" class="hover:bg-gray-700 px-3 py-2 rounded {{ 'bg-gray-700' if page == 'settings' else '' }}">Settings</a>
                <a href="{{ url_for('manage_users') }}" class="hover:bg-gray-700 px-3 py-2 rounded">Manage Users</a>
                <a href="{{ url_for('index', page='audit_log') }}" class="hover:bg-gray-700 px-3 py-2 rounded {{ 'bg-gray-700' if page == 'audit_log' else '' }}">Audit Log</a>
            {% endif %}
            <a href="{{ url_for('two_factor_setup') }}" class="hover:bg-gray-700 px-3 py-2 rounded">2FA Setup</a>
        </div>
        <div>
            <a href="{{ url_for('logout') }}" class="hover:bg-gray-700 px-3 py-2 rounded">Logout</a>
        </div>
    </div>
</nav>

{% if page == 'dashboard' %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold mb-4">Dashboard</h2>
    <p>Status and system insights</p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-100 p-4 rounded-lg">
            <h3 class="text-lg font-medium">Pending Devices</h3>
            <p>{{ chart_data.pending_count }} devices awaiting authorization</p>
        </div>
        <div class="bg-gray-100 p-4 rounded-lg">
            <h3 class="text-lg font-medium">Authorized Devices</h3>
            <p>{{ chart_data.authorized_count }} devices authorized</p>
        </div>
    </div>
    <div class="mt-6">
        <h3 class="text-lg font-medium mb-4">Device Status</h3>
        <canvas id="deviceStatusChart" class="w-full max-w-md mx-auto"></canvas>
    </div>
    <div class="mt-6">
        <h3 class="text-lg font-medium mb-4">Device Groups</h3>
        <canvas id="groupDistributionChart" class="w-full max-w-md mx-auto"></canvas>
    </div>
    <div class="mt-6">
        <h3 class="text-lg font-medium mb-4">Devices Per User</h3>
        <canvas id="userDeviceChart" class="w-full max-w-md mx-auto"></canvas>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const deviceStatusChart = new Chart(document.getElementById('deviceStatusChart'), {
        type: 'bar',
        data: {
            labels: ['Pending', 'Authorized'],
            datasets: [{
                label: 'Device Count',
                data: [{{ chart_data.pending_count }}, {{ chart_data.authorized_count }}],
                backgroundColor: ['#4CAF50', '#2196F3'],
                borderColor: ['#388E3C', '#1976D2'],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Number of Devices' }
                },
                x: { title: { display: true, text: 'Status' } }
            },
            plugins: { legend: { display: false } }
        }
    });

    const groupDistributionChart = new Chart(document.getElementById('groupDistributionChart'), {
        type: 'pie',
        data: {
            labels: {{ chart_data.group_labels | tojson }},
            datasets: [{
                label: 'Devices by Group',
                data: {{ chart_data.group_counts | tojson }},
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                borderColor: ['#FF4069', '#1E87D8', '#FFB300', '#3DA8A8'],
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: { position: 'right' },
                title: { display: true, text: 'Device Group Distribution' }
            }
        }
    });

    const userDeviceChart = new Chart(document.getElementById('userDeviceChart'), {
        type: 'bar',
        data: {
            labels: {{ chart_data.user_labels | tojson }},
            datasets: [{
                label: 'Number of Devices',
                data: {{ chart_data.user_counts | tojson }},
                backgroundColor: '#FF9800',
                borderColor: '#F57C00',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Number of Devices' }
                },
                x: { title: { display: true, text: 'Username' } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>

{% elif page == 'pending' and session['role'] in ['Administrator', 'Approver'] %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold mb-4">Pending Devices for Authorization</h2>
    <table class="w-full table-auto">
        <thead>
            <tr class="bg-gray-200">
                <th class="px-4 py-2">MAC Address</th>
                <th class="px-4 py-2">Seen On</th>
                <th class="px-4 py-2">Switch</th>
                <th class="px-4 py-2">Location</th>
                <th class="px-4 py-2">Port</th>
                <th class="px-4 py-2">Authorize</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr class="border-t">
                <td class="px-4 py-2">{{ device.mac }}</td>
                <td class="px-4 py-2">{{ device.seen }}</td>
                <td class="px-4 py-2">{{ device.switch }}</td>
                <td class="px-4 py-2">{{ device.location }}</td>
                <td class="px-4 py-2">{{ device.port }}</td>
                <td class="px-4 py-2">
                    <form method="POST" action="{{ url_for('authorize_device') }}">
                        {{ authorize_form.hidden_tag() }}
                        <input type="hidden" name="mac" value="{{ device.mac }}">
                        {{ authorize_form.group(class="p-2 border rounded-md") }}
                        {{ authorize_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mt-2") }}
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="bg-white p-6 rounded-lg shadow-md mt-6">
    <h2 class="text-xl font-semibold mb-4">Manually Add New Device</h2>
    <a href="{{ url_for('add_device') }}" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add New Device</a>
</div>

{% elif page == 'devices' and session['role'] == 'Administrator' %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">All MAB Devices</h2>
        <div class="flex space-x-2">
            <a href="{{ url_for('export_devices') }}" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Export CSV</a>
            <button onclick="document.getElementById('import-dialog').showModal()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600">Import CSV</button>
        </div>
    </div>
    <table class="w-full table-auto">
        <thead>
            <tr class="bg-gray-200">
                <th class="px-4 py-2">MAC Address</th>
                <th class="px-4 py-2">Description</th>
                <th class="px-4 py-2">Group</th>
                <th class="px-4 py-2">Assigned User</th>
                <th class="px-4 py-2">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for device in mab_devices %}
            <tr class="border-t">
                <td class="px-4 py-2">{{ device.mac }}</td>
                <td class="px-4 py-2">{{ device.desc }}</td>
                <td class="px-4 py-2">{{ device.group }}</td>
                <td class="px-4 py-2">{{ device.assigned_user or 'N/A' }}</td>
                <td class="px-4 py-2">
                    <a href="{{ url_for('edit_device', mac=device.mac) }}" class="text-blue-500 hover:underline">Edit</a>
                    <form method="POST" action="{{ url_for('delete_device', mac=device.mac) }}" class="inline">
                        <button type="submit" class="text-red-500 hover:underline ml-4" onclick="return confirm('Are you sure you want to delete this device?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{{ url_for('add_device') }}" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mt-4 inline-block">Add New Device</a>
</div>

<dialog id="import-dialog" class="p-6 bg-white rounded-lg shadow-xl">
    <h3 class="text-lg font-semibold mb-4">Import Devices from CSV</h3>
    <form method="POST" action="{{ url_for('import_devices') }}" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" class="mb-4">
        <div class="flex justify-end space-x-2">
            <button type="button" onclick="document.getElementById('import-dialog').close()" class="bg-gray-300 px-4 py-2 rounded-md">Cancel</button>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md">Import</button>
        </div>
    </form>
</dialog>

{% elif page == 'settings' and session['role'] == 'Administrator' %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold mb-4">Settings</h2>
    <form method="POST" action="{{ url_for('settings') }}" class="space-y-4">
        {{ settings_form.hidden_tag() }}
        <div>
            <label class="block text-sm font-medium text-gray-700">SNMP Community String</label>
            {{ settings_form.snmp_community(class="mt-1 p-2 w-full border rounded-md") }}
            {% if settings_form.snmp_community.errors %}
                <p class="text-red-500 text-sm">{{ settings_form.snmp_community.errors[0] }}</p>
            {% endif %}
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Cisco ISE API URL</label>
            {{ settings_form.ise_api_url(class="mt-1 p-2 w-full border rounded-md") }}
            {% if settings_form.ise_api_url.errors %}
                <p class="text-red-500 text-sm">{{ settings_form.ise_api_url.errors[0] }}</p>
            {% endif %}
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Cisco ISE Username</label>
            {{ settings_form.ise_username(class="mt-1 p-2 w-full border rounded-md") }}
            {% if settings_form.ise_username.errors %}
                <p class="text-red-500 text-sm">{{ settings_form.ise_username.errors[0] }}</p>
            {% endif %}
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Cisco ISE Password</label>
            {{ settings_form.ise_password(class="mt-1 p-2 w-full border rounded-md") }}
            {% if settings_form.ise_password.errors %}
                <p class="text-red-500 text-sm">{{ settings_form.ise_password.errors[0] }}</p>
            {% endif %}
        </div>
        {{ settings_form.submit(class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600") }}
    </form>
</div>

{% elif page == 'audit_log' and session['role'] == 'Administrator' %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-xl font-semibold mb-4">Audit Log</h2>
    <table class="w-full table-auto">
        <thead>
            <tr class="bg-gray-200">
                <th class="px-4 py-2">Timestamp</th>
                <th class="px-4 py-2">Username</th>
                <th class="px-4 py-2">Role</th>
                <th class="px-4 py-2">Action</th>
                <th class="px-4 py-2">Details</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr class="border-t">
                <td class="px-4 py-2">{{ log.timestamp }}</td>
                <td class="px-4 py-2">{{ log.username }}</td>
                <td class="px-4 py-2">{{ log.role }}</td>
                <td class="px-4 py-2">{{ log.action }}</td>
                <td class="px-4 py-2">{{ log.details }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
